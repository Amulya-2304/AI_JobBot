{% extends "base.html" %}
{% block content %}
<div class="container">
    <!-- Top Menu -->
    <div style="text-align: right; margin-bottom: 10px;">
        <a href="{{ url_for('profile.profile_page') }}" style="margin-right: 20px; text-decoration: none; color: #007BFF;">View Profile</a>
        <a href="{{ url_for('auth.logout') }}" style="text-decoration: none; color: #007BFF;">Logout</a>
    </div>

    <h2>Welcome, {{ username }}</h2>

    <!-- ðŸ” Keyword-Based Job Search -->
    <form method="POST" action="{{ url_for('dashboard.keyword_search_jobs') }}">
        <label>Search Jobs by Keyword:</label>
        <input type="text" name="keyword" placeholder="e.g. Python Developer">

        <label for="location">Location:</label>
        <input type="text" id="location" name="location" placeholder="Start typing city..." autocomplete="off">
        <div id="city-suggestions" style="border: 1px solid #ccc; max-height: 150px; overflow-y: auto;"></div>

        <label>Job Type:</label>
        <select name="job_type">
            <option value="">--Select--</option>
            <option value="full time">Full Time</option>
            <option value="part time">Part Time</option>
            <option value="remote">Remote</option>
            <option value="work from home">Work From Home</option>
        </select>

        <label>Sort By:</label>
        <select name="sort_by">
            <option value="relevant">Most Relevant</option>
            <option value="24hr">New Listings (24hrs)</option>
            <option value="7days">New Listings (7 days)</option>
        </select>

        <button type="submit">Search</button>
    </form>

    <!-- ðŸ“„ CV-Based Job Search -->
    <form method="POST" action="{{ url_for('dashboard.cv_search_jobs') }}" style="margin-top: 20px;">
        <button type="submit">Search Jobs by Scanned CV</button>
    </form>

    <!-- ðŸ“‹ Job Listings -->
    {% if jobs %}
    <form method="POST" action="{{ url_for('dashboard.prepare_cover_letter') }}">
        <div class="results" style="margin-top: 30px;">
            <h3>Fetched Job Listings ({{ jobs|length }} found):</h3>
            <ul>
                {% for job in jobs %}
                <li style="margin-bottom: 25px; border-bottom: 1px solid #ccc; padding-bottom: 10px;">
                    <div>
                        <input type="checkbox" name="selected_jobs" value="{{ loop.index0 }}" style="margin-right: 10px;">
                        <strong>{{ job.job_title }}</strong> at {{ job.employer_name }}<br>
                        <small>
                            Location: {{ job.job_city }}, {{ job.job_country }} |
                            Type: {{ job.job_type }} |
                            Posted: {{ job.posted_date }}
                        </small><br>
                        <a href="{{ url_for('dashboard.view_job', index=loop.index0) }}">View Job Details</a> |
                        <a href="{{ job.job_url }}" target="_blank">View Full Job Description</a>
                    </div>
                </li>
                {% endfor %}
            </ul>
            <button type="submit">Apply Selected Jobs</button>
        </div>
    </form>
    {% endif %}

    <!-- Pagination -->
    {% if page %}
    <div style="margin-top: 20px;">
        {% if page > 1 %}
            {% if 'keyword' in session %}
                <a href="{{ url_for('dashboard.keyword_search_jobs', page=page-1) }}">Previous</a>
            {% else %}
                <a href="{{ url_for('dashboard.cv_search_jobs', page=page-1) }}">Previous</a>
            {% endif %}
        {% endif %}

        <span>Page {{ page }}</span>

        {% if has_next %}
            {% if 'keyword' in session %}
                <a href="{{ url_for('dashboard.keyword_search_jobs', page=page+1) }}">Next</a>
            {% else %}
                <a href="{{ url_for('dashboard.cv_search_jobs', page=page+1) }}">Next</a>
            {% endif %}
        {% endif %}
    </div>
    {% endif %}

    <!-- ðŸ¤– Chatbot -->
    <div id="chatbot" style="margin-top: 40px; max-width: 500px;">
        <h3>ðŸ¤– Help Chatbot</h3>
        <div id="chat-messages" style="border: 1px solid #ddd; padding: 10px; height: 250px; overflow-y: auto; background: #f9f9f9; margin-bottom: 10px;"></div>
        <form id="chat-form" method="POST" class="d-flex gap-2">
            <input type="text" id="chat-input" name="message" class="form-control" placeholder="Ask me anything about the app..." required>
            <button type="submit" class="btn btn-primary">Send</button>
        </form>
    </div>
</div>

<script>
document.getElementById('location').addEventListener('input', async function() {
    const query = this.value.trim();
    const suggestionBox = document.getElementById('city-suggestions');
    suggestionBox.innerHTML = '';

    if (query.length > 2) {
        try {
            const response = await fetch(`/resolve-cities?namePrefix=${query}`);
            const data = await response.json();
            data.forEach(city => {
                const option = document.createElement('div');
                option.textContent = `${city.city}, ${city.country}`;
                option.style.cursor = "pointer";
                option.onclick = function() {
                    document.getElementById('location').value = `${city.city}, ${city.country}`;
                    suggestionBox.innerHTML = '';
                };
                suggestionBox.appendChild(option);
            });
        } catch (error) {
            console.error("Error fetching city suggestions:", error);
        }
    }
});
</script>

<script>
document.getElementById('chat-form').addEventListener('submit', async function(e) {
    e.preventDefault();
    const inputField = document.getElementById('chat-input');
    const userMessage = inputField.value.trim();
    if (!userMessage) return;

    const chatBox = document.getElementById('chat-messages');
    chatBox.innerHTML += `<div><strong>You:</strong> ${userMessage}</div>`;

    inputField.value = "";

    const res = await fetch("/chatbot", {
        method: "POST",
        headers: { "Content-Type": "application/x-www-form-urlencoded" },
        body: `message=${encodeURIComponent(userMessage)}`
    });

    const data = await res.json();

    setTimeout(() => {
        chatBox.innerHTML += `<div style="color: blue;"><strong>Bot:</strong> ${data.response}</div>`;
        chatBox.scrollTop = chatBox.scrollHeight;
    }, 600);
});
</script>
{% endblock %}